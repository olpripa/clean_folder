import sys
from importlib.machinery import ModuleSpec
from importlib.machinery import all_suffixes as module_suffixes
from importlib.util import spec_from_file_location
from itertools import chain
from pathlib import Path

MAPPING = {'dist': 'D:\\prog\\clean_folder\\clean_folder\\dist', 'sort': 'D:\\prog\\clean_folder\\clean_folder\\sort', 'src': 'D:\\prog\\clean_folder\\clean_folder\\src'}
NAMESPACES = {'dist': ['D:\\prog\\clean_folder\\clean_folder\\dist'], 'sort': ['D:\\prog\\clean_folder\\clean_folder\\sort'], 'src': ['D:\\prog\\clean_folder\\clean_folder\\src'], 'sort.Include': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Include'], 'sort.Lib': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib'], 'sort.Scripts': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Scripts'], 'sort.Lib.site-packages': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib\\site-packages'], 'sort.Lib.site-packages.jaraco': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib\\site-packages\\jaraco'], 'sort.Lib.site-packages.docutils.parsers.rst.include': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib\\site-packages\\docutils\\parsers\\rst\\include'], 'sort.Lib.site-packages.docutils.writers.s5_html.themes': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib\\site-packages\\docutils\\writers\\s5_html\\themes'], 'sort.Lib.site-packages.docutils.writers.s5_html.themes.big-black': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib\\site-packages\\docutils\\writers\\s5_html\\themes\\big-black'], 'sort.Lib.site-packages.docutils.writers.s5_html.themes.big-white': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib\\site-packages\\docutils\\writers\\s5_html\\themes\\big-white'], 'sort.Lib.site-packages.docutils.writers.s5_html.themes.default': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib\\site-packages\\docutils\\writers\\s5_html\\themes\\default'], 'sort.Lib.site-packages.docutils.writers.s5_html.themes.medium-black': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib\\site-packages\\docutils\\writers\\s5_html\\themes\\medium-black'], 'sort.Lib.site-packages.docutils.writers.s5_html.themes.medium-white': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib\\site-packages\\docutils\\writers\\s5_html\\themes\\medium-white'], 'sort.Lib.site-packages.docutils.writers.s5_html.themes.small-black': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib\\site-packages\\docutils\\writers\\s5_html\\themes\\small-black'], 'sort.Lib.site-packages.docutils.writers.s5_html.themes.small-white': ['D:\\prog\\clean_folder\\clean_folder\\sort\\Lib\\site-packages\\docutils\\writers\\s5_html\\themes\\small-white'], 'src.cleanfolder.tests': ['D:\\prog\\clean_folder\\clean_folder\\src\\cleanfolder\\tests']}
PATH_PLACEHOLDER = '__editable__.Schone_Map-0.0.5.finder' + ".__path_hook__"


class _EditableFinder:  # MetaPathFinder
    @classmethod
    def find_spec(cls, fullname, path=None, target=None):
        for pkg, pkg_path in reversed(list(MAPPING.items())):
            if fullname == pkg or fullname.startswith(f"{pkg}."):
                rest = fullname.replace(pkg, "", 1).strip(".").split(".")
                return cls._find_spec(fullname, Path(pkg_path, *rest))

        return None

    @classmethod
    def _find_spec(cls, fullname, candidate_path):
        init = candidate_path / "__init__.py"
        candidates = (candidate_path.with_suffix(x) for x in module_suffixes())
        for candidate in chain([init], candidates):
            if candidate.exists():
                return spec_from_file_location(fullname, candidate)


class _EditableNamespaceFinder:  # PathEntryFinder
    @classmethod
    def _path_hook(cls, path):
        if path == PATH_PLACEHOLDER:
            return cls
        raise ImportError

    @classmethod
    def _paths(cls, fullname):
        # Ensure __path__ is not empty for the spec to be considered a namespace.
        return NAMESPACES[fullname] or MAPPING.get(fullname) or [PATH_PLACEHOLDER]

    @classmethod
    def find_spec(cls, fullname, target=None):
        if fullname in NAMESPACES:
            spec = ModuleSpec(fullname, None, is_package=True)
            spec.submodule_search_locations = cls._paths(fullname)
            return spec
        return None

    @classmethod
    def find_module(cls, fullname):
        return None


def install():
    if not any(finder == _EditableFinder for finder in sys.meta_path):
        sys.meta_path.append(_EditableFinder)

    if not NAMESPACES:
        return

    if not any(hook == _EditableNamespaceFinder._path_hook for hook in sys.path_hooks):
        # PathEntryFinder is needed to create NamespaceSpec without private APIS
        sys.path_hooks.append(_EditableNamespaceFinder._path_hook)
    if PATH_PLACEHOLDER not in sys.path:
        sys.path.append(PATH_PLACEHOLDER)  # Used just to trigger the path hook
